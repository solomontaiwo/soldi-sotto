import{R as H,e as _,f as q,K as F,z as K,u as Q,r as m,b as G,j as e,o as J,B as y,L as N,M as c,N as d,O as C,Q as V,S as W}from"./index-DRslmi_M.js";import{L as u,I as X}from"./label-VHyigIrZ.js";import{C as p,a as f,b as x,c as h,d as L}from"./card-Bv7Ky1fl.js";const Y=()=>{const{currentUser:s,loading:U,logout:D}=_(),{loading:E}=q(),A=U||E,{theme:k,toggleTheme:S}=F(),i=K(),T=Q(),[l,j]=m.useState(""),[v,b]=m.useState(!1),[t,g]=m.useState(""),{t:a,i18n:w}=G();m.useEffect(()=>{(async()=>{if(s?.uid)try{const n=await N(c(d,"users",s.uid));n.exists()?g(n.data().username||s.displayName||s.email?.split("@")[0]||""):g(s.displayName||s.email?.split("@")[0]||"")}catch(n){console.error("Errore nel caricamento username:",n)}})()},[s]);const I=async()=>{await D(),T("/")},P=async r=>{try{return!(await N(c(d,"usernames",r.toLowerCase()))).exists()}catch(n){return console.error("Errore nel controllo username:",n),!1}},O=async()=>{if(!l.trim()||l.length<3){i.error(a("profile.usernameMinLength"));return}if(l.toLowerCase()===t.toLowerCase()){i.info(a("profile.usernameSame"));return}if(window.confirm(a("profile.usernameConfirm",{currentUsername:t,newUsername:l}))){b(!0);try{if(!await P(l)){i.error(a("profile.usernameUnavailable"));return}if(await C(c(d,"usernames",l.toLowerCase()),{uid:s.uid,createdAt:new Date}),await C(c(d,"users",s.uid),{username:l.toLowerCase(),displayName:l,updatedAt:new Date},{merge:!0}),await V(s,{displayName:l}),t&&t.toLowerCase()!==l.toLowerCase())try{await W(c(d,"usernames",t.toLowerCase()))}catch(o){console.warn("Errore nella rimozione del vecchio username (non critico):",o)}g(l),j(""),i.success(a("profile.usernameSuccess"))}catch(n){console.error("Errore nell'aggiornamento username:",n);let o=a("profile.usernameError");n.code==="permission-denied"?o=a("profile.usernamePermissionError"):n.code==="network-request-failed"&&(o=a("profile.usernameNetworkError")),i.error(o)}finally{b(!1)}}},M=s?.metadata?.creationTime?new Date(s.metadata.creationTime).toLocaleDateString("it-IT"):a("profile.dateNotAvailable"),R=[{value:"light",label:a("profile.themeLight")},{value:"dark",label:a("profile.themeDark")},{value:"system",label:a("profile.themeSystem")}],z=[{value:"it",label:"Italiano"},{value:"en",label:"English"}],B=r=>{w.changeLanguage(r.target.value),localStorage.setItem("appLanguage",r.target.value)};return A?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-16 rounded-xl border border-border bg-muted animate-pulse"}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:[...Array(3)].map((r,n)=>e.jsx("div",{className:"h-28 rounded-xl border border-border bg-muted animate-pulse"},n))})]}):e.jsxs("div",{className:"page-shell",children:[e.jsx(J.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},children:e.jsx(p,{className:"glass",children:e.jsxs(f,{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary text-xl",children:s?.email?s.email.charAt(0).toUpperCase():"?"}),e.jsxs("div",{children:[e.jsx(x,{className:"text-2xl",children:t||s?.email}),s?.email&&e.jsxs(h,{className:"text-sm text-muted-foreground",children:[a("profile.emailAddress"),": ",s.email]}),e.jsxs(h,{children:[a("profile.registeredOn"),": ",M]})]})]}),e.jsx(y,{variant:"outline",onClick:I,children:a("navbar.logout")})]})})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(p,{children:[e.jsxs(f,{children:[e.jsx(x,{children:a("profile.editUsername")}),e.jsx(h,{children:a("profile.usernameHelp")})]}),e.jsxs(L,{className:"space-y-3",children:[e.jsx(u,{children:a("profile.currentUsername")}),e.jsx("div",{className:"rounded-lg border border-border bg-muted px-3 py-2 text-sm",children:t||"â€”"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"newUsername",children:a("profile.newUsername")}),e.jsx(X,{id:"newUsername",value:l,onChange:r=>j(r.target.value),placeholder:a("profile.newUsernamePlaceholder")})]}),e.jsx(y,{onClick:O,disabled:v,children:a(v?"profile.updating":"save")})]})]}),e.jsxs(p,{children:[e.jsxs(f,{children:[e.jsx(x,{children:a("profile.settingsTitle")}),e.jsx(h,{children:a("profile.accountInfo")})]}),e.jsxs(L,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:a("profile.theme")}),e.jsx("select",{value:k,onChange:r=>S(r.target.value),className:"h-10 w-full rounded-lg border border-border bg-background px-3 text-sm",children:R.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:a("profile.language")}),e.jsx("select",{value:w.language,onChange:B,className:"h-10 w-full rounded-lg border border-border bg-background px-3 text-sm",children:z.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]})]})]})]})]})},ae=H.memo(Y);export{ae as default};
