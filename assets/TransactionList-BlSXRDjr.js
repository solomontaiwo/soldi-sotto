import{r as l,R as Me,c as Se,d as De,b as ke,a as Le,j as e,B as y,e as Z,i as Fe,k as Re,l as Ae,A as Ee,m as k,n as Ie,o as Oe}from"./index-DVNr0Sae.js";import{T as ze,D as Pe,a as _e,b as Be,c as Qe,d as Ue,e as qe}from"./TransactionModal-E0wlfX_i.js";import{t as He,a as F,n as $e,s as ee,i as Ve,S as L,b as Q,f as se}from"./statsUtils-CUIURLah.js";import{u as We}from"./categories-C8NGgGe-.js";import{I as Ge}from"./label-DmEWnETg.js";import{u as Ke}from"./useDateRange-dC5ikvwQ.js";import{f as U,i as Ye,e as Je}from"./it-CJdkJUCk.js";function Xe(r,c,i){const h=He(r,i?.in);return isNaN(c)?F(r,NaN):(h.setDate(h.getDate()+c),h)}function te(r){return F(r,Date.now())}function ae(r,c,i){const[h,x]=$e(i?.in,r,c);return+ee(h)==+ee(x)}function Ze(r,c){return ae(F(r,r),te(r))}function es(r,c,i){return Xe(r,-1,i)}function ss(r,c){return ae(F(r,r),es(te(r)))}const ts=(r,c)=>{const[i,h]=l.useState(""),[x,N]=l.useState("all"),[p,d]=l.useState("all");return{filteredTransactions:l.useMemo(()=>{if(!r||r.length===0)return[];const{startDate:C,endDate:T}=c;return[...r].sort((m,j)=>j.date-m.date).filter(m=>{if(C&&T&&(!m.date||!Ve(m.date,{start:C,end:T})))return!1;if(i){const j=i.toLowerCase(),f=m.description.toLowerCase().includes(j),w=m.category.toLowerCase().includes(j);if(!f&&!w)return!1}return!(x!=="all"&&m.category!==x||p!=="all"&&m.type!==p)})},[r,c,i,x,p]),searchTerm:i,setSearchTerm:h,selectedCategory:x,setSelectedCategory:N,selectedType:p,setSelectedType:d}},as=()=>{const{currentUser:r,loading:c}=Se(),{transactions:i,loading:h,deleteTransaction:x,addTransaction:N,updateTransaction:p,isDemo:d,canAddMoreTransactions:R,maxTransactions:C,fetchAllTransactions:T,getTotalTransactionCount:A}=De(),{expenseCategories:m,incomeCategories:j}=We(),[f,w]=l.useState(null),[g,M]=l.useState(null),[ne,E]=l.useState(!1),[S,re]=l.useState(!1),[u,D]=l.useState([]),[I,q]=l.useState(!1),[O,ie]=l.useState(!0),[z,P]=l.useState(0),{period:le,setPeriod:oe,startDate:ce,endDate:de}=Ke("monthly");l.useEffect(()=>{(async()=>{if(r&&!d){const n=await A();P(n)}else d&&P(i.length)})()},[r,d,A,i]),l.useEffect(()=>{i.length>0&&D(s=>{const n=new Map(s.map(t=>[t.id,t]));return i.forEach(t=>{n.set(t.id,t)}),s.length===0||s.length<=i.length?[...i].sort((t,o)=>o.date-t.date):Array.from(n.values()).sort((t,o)=>o.date-t.date)})},[i]);const H=async()=>{q(!0);const s=await T();D(s),P(s.length),ie(!1),q(!1)},$=l.useRef(null);l.useEffect(()=>{const s=new IntersectionObserver(t=>{t[0].isIntersecting&&O&&!I&&!d&&u.length>0&&z>u.length&&H()},{threshold:.1,rootMargin:"100px"}),n=$.current;return n&&s.observe(n),()=>{n&&s.unobserve(n)}},[O,I,d,u.length,z,H]);const{filteredTransactions:ue,searchTerm:V,setSearchTerm:me,selectedCategory:W,setSelectedCategory:he,selectedType:G,setSelectedType:xe}=ts(u.length>0?u:i,{startDate:ce,endDate:de}),{t:a,i18n:_}=ke(),fe=Le({maxWidth:768}),pe=c||h&&u.length===0,b=l.useMemo(()=>a("dashboard.motivationalQuotes",{returnObjects:!0}),[a]),[ge,ye]=l.useState("");l.useEffect(()=>{b&&b.length>0&&ye(b[Math.floor(Math.random()*b.length)])},[b]);const K=s=>s==="it"?Ye:Je,Y=s=>{const n=_.language||"it";if(Ze(s))return a("transactions.today");if(ss(s))return a("transactions.yesterday");const t=K(n);return U(s,n==="it"?"d MMMM yyyy":"MMMM d, yyyy",{locale:t})},je=s=>{const n={};return s.forEach(t=>{const o=t.date,v=U(o,"yyyy-MM-dd");n[v]||(n[v]={date:o,displayDate:Y(o),transactions:[]}),n[v].transactions.push(t)}),Object.values(n).sort((t,o)=>o.date-t.date)},J=s=>{const t=[...m,...j].find(o=>o.value===s);return t?t.label:a(`categories.${s}`,{defaultValue:s})},ve=l.useCallback(async s=>{M(s)},[]),be=l.useCallback(async()=>{g&&(await x(g)&&M(null),D(n=>n.filter(t=>t.id!==g)))},[g,x]),Ne=[...new Set(u.length>0?u.map(s=>s.category):i.map(s=>s.category))],Ce=[{value:"daily",label:a("transactions.filters.today")},{value:"weekly",label:a("transactions.filters.week")},{value:"monthly",label:a("transactions.filters.month")},{value:"annually",label:a("transactions.filters.year")},{value:"all",label:a("transactions.filters.all")}],Te=l.useCallback(async s=>{const n=s.amount?.toString().replace(",",".")||"",t=parseFloat(n);if(Number.isNaN(t)||t<=0)return!1;const o={type:s.type,amount:t,description:s.description,date:new Date(s.date),category:s.category};if(f){const v=await p(f.id,o);return v&&D(we=>we.map(B=>B.id===f.id?{...B,...o}:B)),v}return N(o)},[N,p,f]);if(pe)return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(L,{height:120,borderRadius:16}),e.jsx(L,{height:120,borderRadius:16})]}),[...Array(4)].map((s,n)=>e.jsxs("div",{className:"space-y-3",children:[e.jsx(L,{width:140,height:20}),e.jsx(L,{height:72,borderRadius:18})]},n))]});if(!r&&!d)return e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("h2",{className:"text-2xl font-semibold",children:a("transactions.accessRequired")}),e.jsx("p",{className:"text-muted-foreground",children:a("transactions.loginRequired")})]})});const X=je(ue);return e.jsxs("div",{className:"page-shell -mt-6 pt-0",children:[e.jsxs("div",{className:"sticky top-0 z-20 rounded-2xl border border-border bg-card/90 backdrop-blur-md p-3 md:p-4 shadow-md",children:[e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl md:text-2xl font-bold flex items-center gap-2",children:["ðŸ’³ ",a("transactions.title")]}),e.jsx("div",{className:"text-primary text-sm italic",children:ge})]}),e.jsxs(y,{onClick:()=>E(!0),disabled:d&&!R,className:"gap-2",children:[e.jsx(Z,{}),!fe&&a("addTransaction")]})]}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Fe,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground"}),e.jsx(Ge,{className:"pl-10",placeholder:a("searchTransactions"),value:V,onChange:s=>me(s.target.value)})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row",children:[e.jsx(Q,{value:le,onChange:s=>oe(s.target.value),className:"md:flex-1",children:Ce.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsxs(y,{variant:S?"default":"outline",size:"sm",onClick:()=>re(!S),className:"w-full md:w-auto gap-2",children:[e.jsx(Re,{}),a(S?"transactions.filters.hide":"transactions.filters.show")]})]}),d&&e.jsxs("div",{className:"rounded-xl border border-primary/20 bg-primary/5 px-3 py-2 text-sm text-primary flex items-center gap-2",children:[e.jsxs(Ae,{variant:"secondary",children:[i.filter(s=>!s.isSample).length,"/",C]}),e.jsx("span",{children:a("transactions.demoMode")})]}),e.jsx(Ee,{children:S&&e.jsxs(k.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"grid gap-3 md:grid-cols-2",children:[e.jsxs(Q,{value:G,onChange:s=>xe(s.target.value),children:[e.jsx("option",{value:"all",children:a("transactions.filters.allTypes")}),e.jsx("option",{value:"income",children:a("income")}),e.jsx("option",{value:"expense",children:a("expense")})]}),e.jsxs(Q,{value:W,onChange:s=>he(s.target.value),children:[e.jsx("option",{value:"all",children:"Categorie"}),Ne.map(s=>e.jsx("option",{value:s,children:s.charAt(0).toUpperCase()+s.slice(1)},s))]})]})})]})]}),e.jsxs("div",{className:"space-y-4 pb-6 pt-3",children:[X.length>0?X.map((s,n)=>e.jsxs(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:n*.05},className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"rounded-full bg-muted px-3 py-1 text-xs font-semibold text-muted-foreground",children:s.displayDate}),e.jsx("div",{className:"h-px flex-1 bg-border"})]}),e.jsx("div",{className:"space-y-2",children:s.transactions.map(t=>e.jsxs(k.div,{initial:{opacity:0,x:-12},animate:{opacity:1,x:0},className:"flex items-center justify-between rounded-2xl border border-border bg-card/80 p-4 shadow-sm",children:[e.jsx("div",{className:"flex items-start gap-3",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-base font-semibold leading-tight",children:t.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:U(t.date,_.language==="it"?"dd MMM yyyy":"MMM dd, yyyy",{locale:K(_.language)})}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:J(t.category)})]})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:`text-base font-bold ${t.type==="income"?"text-emerald-600":"text-rose-600"}`,children:[t.type==="income"?"+":"-",se(t.amount)]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(y,{size:"sm",variant:"ghost",className:"h-9 w-9 p-0",onClick:o=>{o.stopPropagation(),w(t)},children:e.jsx(Ie,{className:"h-4 w-4"})}),e.jsx(y,{size:"sm",variant:"ghost",className:"h-9 w-9 p-0 text-destructive hover:text-destructive",onClick:o=>{o.stopPropagation(),ve(t.id)},children:e.jsx(Oe,{className:"h-4 w-4"})})]})]})]},t.id))})]},s.date.toISOString())):e.jsxs(k.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"text-center py-10",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground",children:a("transactions.empty.title")}),e.jsx("p",{className:"text-muted-foreground",children:a(V||W!=="all"||G!=="all"?"transactions.empty.tryFilters":"transactions.empty.addFirst")}),e.jsxs(y,{className:"mt-4 gap-2",onClick:()=>E(!0),disabled:d&&!R,children:[e.jsx(Z,{}),a("addTransaction")]})]}),O&&!d&&u.length>0&&z>u.length&&e.jsx("div",{ref:$,className:"flex justify-center py-6",children:I&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"}),a("loading")]})})]}),e.jsx(ze,{show:ne||!!f,onClose:()=>{E(!1),w(null)},onSubmit:Te,transaction:f}),e.jsx(Pe,{open:!!g,onOpenChange:s=>!s&&M(null),children:e.jsxs(_e,{children:[e.jsxs(Be,{children:[e.jsx(Qe,{children:a("confirmDelete")}),e.jsx(Ue,{children:a("transactions.deleteConfirm")})]}),(()=>{const s=u.find(n=>n.id===g)||i.find(n=>n.id===g);return s?e.jsxs("div",{className:"py-4 space-y-1",children:[e.jsx("div",{className:"font-bold text-foreground",children:s.description}),e.jsxs("div",{className:"text-muted-foreground text-sm",children:[Y(s.date)," â€¢"," ",J(s.category)]}),e.jsxs("div",{className:`font-semibold ${s.type==="income"?"text-emerald-600":"text-rose-600"}`,children:[s.type==="income"?"+":"-",se(s.amount)]})]}):null})(),e.jsxs(qe,{className:"gap-2",children:[e.jsx(y,{variant:"outline",onClick:()=>M(null),children:a("cancel")}),e.jsx(y,{variant:"destructive",onClick:be,children:a("transactions.deleteConfirm")})]})]})})]})},us=Me.memo(as);export{us as default};
