import{R as Q,e as $,f as G,K as J,C as V,u as W,r as i,b as X,j as e,p as Y,B as L,L as U,M as d,N as m,O as D,Q as Z,S as ee}from"./index-Cwjf0OAa.js";import{f as ae}from"./formatCurrency-DQxE0pTn.js";import{L as u,I as re}from"./label-DlHmEvRc.js";import{C as f,a as g,b as h,c as p,d as S}from"./card-Bikq4X2Z.js";const se=()=>{const{currentUser:s,loading:E,logout:T}=$(),{transactions:x,getStats:v,loading:A}=G(),k=E||A,{theme:I,toggleTheme:M}=J(),o=V(),O=W(),[b,P]=i.useState({}),[n,w]=i.useState(""),[y,N]=i.useState(!1),[l,j]=i.useState(""),{t:a,i18n:C}=X();i.useEffect(()=>{v&&P(v())},[x,v]),i.useEffect(()=>{(async()=>{if(s?.uid)try{const t=await U(d(m,"users",s.uid));t.exists()?j(t.data().username||s.displayName||s.email?.split("@")[0]||""):j(s.displayName||s.email?.split("@")[0]||"")}catch(t){console.error("Errore nel caricamento username:",t)}})()},[s]);const B=async()=>{await T(),O("/")},R=async r=>{try{return!(await U(d(m,"usernames",r.toLowerCase()))).exists()}catch(t){return console.error("Errore nel controllo username:",t),!1}},H=async()=>{if(!n.trim()||n.length<3){o.error(a("profile.usernameMinLength"));return}if(n.toLowerCase()===l.toLowerCase()){o.info(a("profile.usernameSame"));return}if(window.confirm(a("profile.usernameConfirm",{currentUsername:l,newUsername:n}))){N(!0);try{if(!await R(n)){o.error(a("profile.usernameUnavailable"));return}if(await D(d(m,"usernames",n.toLowerCase()),{uid:s.uid,createdAt:new Date}),await D(d(m,"users",s.uid),{username:n.toLowerCase(),displayName:n,updatedAt:new Date},{merge:!0}),await Z(s,{displayName:n}),l&&l.toLowerCase()!==n.toLowerCase())try{await ee(d(m,"usernames",l.toLowerCase()))}catch(c){console.warn("Errore nella rimozione del vecchio username (non critico):",c)}j(n),w(""),o.success(a("profile.usernameSuccess"))}catch(t){console.error("Errore nell'aggiornamento username:",t);let c=a("profile.usernameError");t.code==="permission-denied"?c=a("profile.usernamePermissionError"):t.code==="network-request-failed"&&(c=a("profile.usernameNetworkError")),o.error(c)}finally{N(!1)}}},_=s?.metadata?.creationTime?new Date(s.metadata.creationTime).toLocaleDateString("it-IT"):a("profile.dateNotAvailable"),q=i.useMemo(()=>[{title:a("profile.totalTransactions"),value:x.length},{title:a("profile.currentBalance"),value:ae(b.balance||0)},{title:a("profile.daysActive"),value:s?.metadata?.creationTime?Math.floor((Date.now()-new Date(s.metadata.creationTime))/(1e3*60*60*24)):0,suffix:` ${a("profile.days")}`}],[x.length,b.balance,s?.metadata?.creationTime,a]),z=[{value:"light",label:a("profile.themeLight")},{value:"dark",label:a("profile.themeDark")},{value:"system",label:a("profile.themeSystem")}],F=[{value:"it",label:"Italiano"},{value:"en",label:"English"}],K=r=>{C.changeLanguage(r.target.value),localStorage.setItem("appLanguage",r.target.value)};return k?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-16 rounded-xl border border-border bg-muted animate-pulse"}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:[...Array(3)].map((r,t)=>e.jsx("div",{className:"h-28 rounded-xl border border-border bg-muted animate-pulse"},t))})]}):e.jsxs("div",{className:"page-shell",children:[e.jsx(Y.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},children:e.jsx(f,{className:"glass",children:e.jsxs(g,{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary text-xl",children:s?.email?s.email.charAt(0).toUpperCase():"?"}),e.jsxs("div",{children:[e.jsx(h,{className:"text-2xl",children:l||s?.email}),e.jsxs(p,{children:[a("profile.registeredOn"),": ",_]})]})]}),e.jsx(L,{variant:"outline",onClick:B,children:a("navbar.logout")})]})})}),e.jsx("div",{className:"grid gap-4 md:grid-cols-3",children:q.map((r,t)=>e.jsx(f,{className:"glass",children:e.jsxs(g,{children:[e.jsx(h,{className:"text-sm text-muted-foreground",children:r.title}),e.jsxs(p,{className:"text-2xl font-semibold text-foreground",children:[r.value,r.suffix]})]})},t))}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(f,{children:[e.jsxs(g,{children:[e.jsx(h,{children:a("profile.editUsername")}),e.jsx(p,{children:a("profile.usernameHelp")})]}),e.jsxs(S,{className:"space-y-3",children:[e.jsx(u,{children:a("profile.currentUsername")}),e.jsx("div",{className:"rounded-lg border border-border bg-muted px-3 py-2 text-sm",children:l||"â€”"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"newUsername",children:a("profile.newUsername")}),e.jsx(re,{id:"newUsername",value:n,onChange:r=>w(r.target.value),placeholder:"nuovo-username"})]}),e.jsx(L,{onClick:H,disabled:y,children:a(y?"profile.updating":"save")})]})]}),e.jsxs(f,{children:[e.jsxs(g,{children:[e.jsx(h,{children:a("profile.settingsTitle")}),e.jsx(p,{children:a("profile.accountInfo")})]}),e.jsxs(S,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:a("profile.theme")}),e.jsx("select",{value:I,onChange:r=>M(r.target.value),className:"h-10 w-full rounded-lg border border-border bg-background px-3 text-sm",children:z.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:a("profile.language")}),e.jsx("select",{value:C.language,onChange:K,className:"h-10 w-full rounded-lg border border-border bg-background px-3 text-sm",children:F.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]})]})]})]})]})},oe=Q.memo(se);export{oe as default};
