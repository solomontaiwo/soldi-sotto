import{R as te,d as ae,c as ne,b as re,r as C,j as e,m as z,D as H,B as _,l as le,z as oe,y as ie,E as ce,G as de,H as me}from"./index-DVNr0Sae.js";import{c as xe,i as G,d as pe,e as V,h as ue,S as L,b as ge,f as d}from"./statsUtils-CUIURLah.js";import{u as he}from"./categories-C8NGgGe-.js";import{C as f,a as y,b as j,d as b}from"./card-D_gtHubT.js";import{g as fe,a as ye}from"./pdfUtils-CWpYyYdN.js";import{u as je}from"./useDateRange-dC5ikvwQ.js";import{f as W}from"./it-CJdkJUCk.js";const be=()=>{const{isDemo:A,transactions:E,maxTransactions:O,loading:Y,fetchAllTransactions:U}=ae(),{currentUser:I}=ne(),{expenseCategories:B,incomeCategories:P}=he(),{t,i18n:q}=re(),{period:m,setPeriod:K,customRange:v,setCustomRange:J,startDate:x,endDate:p}=je(localStorage.getItem("analytics-period")?JSON.parse(localStorage.getItem("analytics-period")).period:"month",localStorage.getItem("analytics-period")?JSON.parse(localStorage.getItem("analytics-period")).customRange:null),[N,k]=C.useState([]),[Q,S]=C.useState(!0);C.useEffect(()=>{(async()=>{if(A)k(E),S(!1);else if(I){S(!0);const a=await U();k(a),S(!1)}else k([]),S(!1)})()},[A,E,I,U]),C.useEffect(()=>{localStorage.setItem("analytics-period",JSON.stringify({period:m,customRange:v}))},[m,v]);const r=C.useMemo(()=>xe(N,x,p),[N,x,p]),l=C.useMemo(()=>{if(!N.length)return{};const s=(n,g,F)=>Object.entries(n).sort(([,c],[,h])=>h-c).slice(0,5).map(([c,h])=>{const o=F.find(D=>D.value===c)?.label||t(`categories.${c}`,{defaultValue:c});return{category:c,amount:h,percentage:g>0?h/g*100:0,label:o.replace(/^[^\p{L}\p{N}]+/u,"").trim()}}),a=N.filter(n=>n.date&&G(n.date,{start:x,end:p})),T={},w={};a.forEach(n=>{n.type==="expense"?T[n.category]=(T[n.category]||0)+n.amount:w[n.category]=(w[n.category]||0)+n.amount});const M=s(T,r.totalExpense,B),u=s(w,r.totalIncome,P),R=new Date,i=[];for(let n=5;n>=0;n--){const g=pe(V(R,n)),F=ue(V(R,n)),c=N.filter(o=>o.date&&G(o.date,{start:g,end:F})),h=c.filter(o=>o.type==="income").reduce((o,D)=>o+D.amount,0),$=c.filter(o=>o.type==="expense").reduce((o,D)=>o+D.amount,0);i.push({month:W(g,"MMM yyyy"),income:h,expense:$,balance:h-$})}const ee=a.length>0?a.reduce((n,g)=>n+g.amount,0)/a.length:0,se=r.totalIncome>0?(r.totalIncome-r.totalExpense)/r.totalIncome*100:0;return{topExpenseCategories:M,topIncomeCategories:u,monthlyTrend:i,avgTransactionAmount:ee,savingsRate:se,filteredTransactions:a}},[N,x,p,r,B,P,t]),X=()=>{if(!l?.filteredTransactions?.length)return;const s=["Data","Tipo","Descrizione","Categoria","Importo"],a=l.filteredTransactions.map(i=>[W(i.date,"yyyy-MM-dd"),i.type,`"${(i.description||"").replace(/"/g,'""')}"`,i.category||"",i.amount]),T=[s.join(","),...a.map(i=>i.join(","))].join(`
`),w=new Blob([T],{type:"text/csv;charset=utf-8;"}),M=URL.createObjectURL(w),u=document.createElement("a");u.href=M;const R=fe(m,x,p,I,"csv");u.setAttribute("download",R),document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(M)},Z=async()=>{!l?.filteredTransactions?.length||!x||!p||await ye(l.filteredTransactions,x,p,m==="custom"?`${t("analytics.custom")} (${v.from} - ${v.to})`:m,q.language,I)};return Y||Q?e.jsxs("div",{className:"space-y-4",children:[e.jsx(L,{height:48}),e.jsx("div",{className:"grid gap-3 md:grid-cols-2 lg:grid-cols-4",children:[...Array(4)].map((s,a)=>e.jsx(L,{height:120,borderRadius:18},a))}),e.jsx(L,{height:220,borderRadius:18})]}):e.jsxs("div",{className:"page-shell",children:[e.jsxs(z.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(H,{className:"text-primary"})," ",t("analytics.title")]}),e.jsx("p",{className:"text-muted-foreground",children:t("analytics.subtitle")})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:gap-4 md:flex-wrap",children:[e.jsxs(ge,{value:m,onChange:s=>K(s.target.value),className:"md:w-48 h-11 self-center",children:[e.jsx("option",{value:"month",children:t("analytics.thisMonth")}),e.jsx("option",{value:"lastMonth",children:t("analytics.lastMonth")}),e.jsx("option",{value:"last3Months",children:t("analytics.last3Months")}),e.jsx("option",{value:"year",children:t("analytics.thisYear")}),e.jsx("option",{value:"custom",children:t("analytics.custom")})]}),m==="custom"&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 md:gap-3 text-sm md:items-center md:pl-1",children:[e.jsx("label",{className:"text-muted-foreground text-xs md:text-sm leading-none",children:t("analytics.from")}),e.jsx("input",{type:"date",value:v.from,onChange:s=>J(a=>({...a,from:s.target.value})),className:"h-11 rounded-lg border border-border bg-background px-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background md:min-w-[170px]"}),e.jsx("label",{className:"text-muted-foreground text-xs md:text-sm leading-none",children:t("analytics.to")}),e.jsx("input",{type:"date",value:v.to,onChange:s=>J(a=>({...a,to:s.target.value})),className:"h-11 rounded-lg border border-border bg-background px-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background md:min-w-[170px]"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(_,{variant:"outline",onClick:X,disabled:!l?.filteredTransactions?.length,children:t("analytics.exportCsv")}),e.jsx(_,{variant:"outline",onClick:Z,disabled:!l?.filteredTransactions?.length,children:t("analytics.exportPdf")})]})]})]}),A&&e.jsxs("div",{className:"rounded-xl border border-primary/20 bg-primary/5 px-3 py-2 text-sm text-primary flex items-center gap-2",children:[e.jsxs(le,{variant:"secondary",children:[E.filter(s=>!s.isSample).length,"/",O]}),e.jsx("span",{children:t("analytics.demoDescription",{current:E.filter(s=>!s.isSample).length,max:O})})]})]}),e.jsx(z.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},children:e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[{title:t("analytics.totalIncome"),value:r.totalIncome,icon:e.jsx(oe,{}),color:"text-emerald-600"},{title:t("analytics.totalExpense"),value:r.totalExpense,icon:e.jsx(ie,{}),color:"text-rose-600"},{title:t("analytics.balance"),value:r.balance,icon:e.jsx(H,{}),color:"text-primary"},{title:t("analytics.totalTransactions"),value:r.transactionCount,icon:e.jsx(ce,{}),color:"text-muted-foreground"}].map((s,a)=>e.jsxs(f,{children:[e.jsx(y,{children:e.jsxs(j,{className:"flex items-center gap-2 text-base",children:[e.jsx("span",{className:`text-lg ${s.color}`,children:s.icon}),s.title]})}),e.jsx(b,{children:e.jsx("p",{className:"text-2xl font-semibold",children:typeof s.value=="number"&&a!==3?d(s.value):s.value})})]},a))})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(f,{children:[e.jsx(y,{children:e.jsx(j,{children:t("analytics.topExpenseCategories")})}),e.jsx(b,{className:"space-y-3",children:l.topExpenseCategories?.length?l.topExpenseCategories.map((s,a)=>e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"font-semibold",children:s.label})}),e.jsx("span",{className:"text-rose-600 font-semibold",children:d(s.amount)})]}),e.jsx("div",{className:"h-2 w-full rounded-full bg-muted",children:e.jsx("div",{className:"h-2 rounded-full bg-rose-500",style:{width:`${s.percentage.toFixed(1)}%`}})})]},a)):e.jsx("p",{className:"text-sm text-muted-foreground",children:t("analytics.noExpenseData")})})]}),e.jsxs(f,{children:[e.jsx(y,{children:e.jsx(j,{children:t("analytics.topIncomeCategories")})}),e.jsx(b,{className:"space-y-3",children:l.topIncomeCategories?.length?l.topIncomeCategories.map((s,a)=>e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"font-semibold",children:s.label})}),e.jsx("span",{className:"text-emerald-600 font-semibold",children:d(s.amount)})]}),e.jsx("div",{className:"h-2 w-full rounded-full bg-muted",children:e.jsx("div",{className:"h-2 rounded-full bg-emerald-500",style:{width:`${s.percentage.toFixed(1)}%`}})})]},a)):e.jsx("p",{className:"text-sm text-muted-foreground",children:t("analytics.noIncomeData")})})]})]}),e.jsxs(f,{children:[e.jsx(y,{children:e.jsx(j,{children:t("analytics.monthlyTrend")})}),e.jsx(b,{className:"grid gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6",children:l.monthlyTrend?.length?l.monthlyTrend.map((s,a)=>e.jsxs("div",{className:`rounded-xl border border-border p-3 ${s.balance>=0?"bg-emerald-500/5":"bg-rose-500/5"}`,children:[e.jsx("p",{className:"text-sm font-semibold",children:s.month}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-emerald-600",children:[e.jsx(de,{})," ",d(s.income)]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-rose-600",children:[e.jsx(me,{})," ",d(s.expense)]}),e.jsx("p",{className:`text-sm font-semibold ${s.balance>=0?"text-emerald-600":"text-rose-600"}`,children:d(s.balance)})]},a)):e.jsx("p",{className:"text-sm text-muted-foreground",children:t("analytics.insufficientData")})})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(f,{children:[e.jsx(y,{children:e.jsx(j,{children:t("analytics.avgDailyExpense")})}),e.jsxs(b,{children:[e.jsx("p",{className:"text-2xl font-semibold text-primary",children:d(r.dailyAverageExpense||0)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("analytics.inSelectedPeriod")})]})]}),e.jsxs(f,{children:[e.jsx(y,{children:e.jsx(j,{children:t("analytics.avgTransaction")})}),e.jsxs(b,{children:[e.jsx("p",{className:"text-2xl font-semibold text-primary",children:d(l.avgTransactionAmount||0)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("analytics.avgTransactionDescription")})]})]}),e.jsxs(f,{children:[e.jsx(y,{children:e.jsx(j,{children:t("analytics.totalTransactions")})}),e.jsxs(b,{children:[e.jsx("p",{className:"text-2xl font-semibold text-primary",children:r.transactionCount||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t("analytics.inSelectedPeriod")})]})]})]})]})},Ie=te.memo(be);export{Ie as default};
