import{R as _,c as q,d as z,K as F,x as K,u as Q,r as m,b as G,j as e,m as J,B as y,L as N,M as c,N as d,O as C,Q as V,S as W}from"./index-DVNr0Sae.js";import{L as u,I as X}from"./label-DmEWnETg.js";import{C as f,a as x,b as j,c as g,d as L}from"./card-D_gtHubT.js";const Y=()=>{const{currentUser:s,loading:U,logout:D}=q(),{loading:E}=z(),A=U||E,{theme:S,toggleTheme:k}=F(),i=K(),T=Q(),[l,v]=m.useState(""),[b,w]=m.useState(!1),[t,h]=m.useState(""),{t:a,i18n:p}=G();m.useEffect(()=>{(async()=>{if(s?.uid)try{const n=await N(c(d,"users",s.uid));n.exists()?h(n.data().username||s.displayName||s.email?.split("@")[0]||""):h(s.displayName||s.email?.split("@")[0]||"")}catch(n){console.error("Errore nel caricamento username:",n)}})()},[s]);const I=async()=>{await D(),T("/")},P=async r=>{try{return!(await N(c(d,"usernames",r.toLowerCase()))).exists()}catch(n){return console.error("Errore nel controllo username:",n),!1}},O=async()=>{if(!l.trim()||l.length<3){i.error(a("profile.usernameMinLength"));return}if(l.toLowerCase()===t.toLowerCase()){i.info(a("profile.usernameSame"));return}if(window.confirm(a("profile.usernameConfirm",{currentUsername:t,newUsername:l}))){w(!0);try{if(!await P(l)){i.error(a("profile.usernameUnavailable"));return}if(await C(c(d,"usernames",l.toLowerCase()),{uid:s.uid,createdAt:new Date}),await C(c(d,"users",s.uid),{username:l.toLowerCase(),displayName:l,updatedAt:new Date},{merge:!0}),await V(s,{displayName:l}),t&&t.toLowerCase()!==l.toLowerCase())try{await W(c(d,"usernames",t.toLowerCase()))}catch(o){console.warn("Errore nella rimozione del vecchio username (non critico):",o)}h(l),v(""),i.success(a("profile.usernameSuccess"))}catch(n){console.error("Errore nell'aggiornamento username:",n);let o=a("profile.usernameError");n.code==="permission-denied"?o=a("profile.usernamePermissionError"):n.code==="network-request-failed"&&(o=a("profile.usernameNetworkError")),i.error(o)}finally{w(!1)}}},M=s?.metadata?.creationTime?new Date(s.metadata.creationTime).toLocaleDateString(p.language==="it"?"it-IT":"en-US"):a("profile.dateNotAvailable"),R=[{value:"light",label:a("profile.themeLight")},{value:"dark",label:a("profile.themeDark")},{value:"system",label:a("profile.themeSystem")}],B=[{value:"it",label:"Italiano"},{value:"en",label:"English"}],H=r=>{p.changeLanguage(r.target.value),localStorage.setItem("appLanguage",r.target.value)};return A?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-16 rounded-xl border border-border bg-muted animate-pulse"}),e.jsx("div",{className:"grid gap-3 md:grid-cols-3",children:[...Array(3)].map((r,n)=>e.jsx("div",{className:"h-28 rounded-xl border border-border bg-muted animate-pulse"},n))})]}):e.jsxs("div",{className:"page-shell",children:[e.jsx(J.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},children:e.jsx(f,{className:"glass",children:e.jsxs(x,{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary text-xl",children:s?.email?s.email.charAt(0).toUpperCase():"?"}),e.jsxs("div",{children:[e.jsx(j,{className:"text-2xl",children:t||s?.email}),s?.email&&e.jsxs(g,{className:"text-sm text-muted-foreground",children:[a("profile.emailAddress"),": ",s.email]}),e.jsxs(g,{children:[a("profile.registeredOn"),": ",M]})]})]}),e.jsx(y,{variant:"outline",onClick:I,children:a("navbar.logout")})]})})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(f,{children:[e.jsxs(x,{children:[e.jsx(j,{children:a("profile.editUsername")}),e.jsx(g,{children:a("profile.usernameHelp")})]}),e.jsxs(L,{className:"space-y-3",children:[e.jsx(u,{children:a("profile.currentUsername")}),e.jsx("div",{className:"rounded-lg border border-border bg-muted px-3 py-2 text-sm",children:t||"â€”"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"newUsername",children:a("profile.newUsername")}),e.jsx(X,{id:"newUsername",value:l,onChange:r=>v(r.target.value),placeholder:a("profile.newUsernamePlaceholder")})]}),e.jsx(y,{onClick:O,disabled:b,children:a(b?"profile.updating":"save")})]})]}),e.jsxs(f,{children:[e.jsxs(x,{children:[e.jsx(j,{children:a("profile.settingsTitle")}),e.jsx(g,{children:a("profile.accountInfo")})]}),e.jsxs(L,{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:a("profile.theme")}),e.jsx("select",{value:S,onChange:r=>k(r.target.value),className:"h-10 w-full rounded-lg border border-border bg-background px-3 text-sm",children:R.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:a("profile.language")}),e.jsx("select",{value:p.language,onChange:H,className:"h-10 w-full rounded-lg border border-border bg-background px-3 text-sm",children:B.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]})]})]})]})]})},ae=_.memo(Y);export{ae as default};
