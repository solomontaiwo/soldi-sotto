import{R as ie,f as ce,r as D,b as de,j as e,p as J,E as z,B as G,o as me,c as xe,d as pe,G as ue,H as he,I as fe}from"./index-Cwjf0OAa.js";import{f as v}from"./formatCurrency-DQxE0pTn.js";import{u as ge}from"./categories-ChY1Iypg.js";import{t as $,c as V,a as k,e as I,b as je,d as ye,S as P,i as be}from"./endOfWeek-0_09HUBs.js";import{C,a as T,b as w,d as M,c as W}from"./card-Bikq4X2Z.js";import{g as ve}from"./pdfUtils-2b9DnFbB.js";import{f as q}from"./format-BwYqTgFN.js";import"./differenceInDays-BUqUuyZx.js";function Ne(b,l,h){const m=$(b,h?.in);if(isNaN(l))return V(b,NaN);if(!l)return m;const N=m.getDate(),f=V(b,m.getTime());f.setMonth(m.getMonth()+l+1,0);const E=f.getDate();return N>=E?f:(m.setFullYear(f.getFullYear(),f.getMonth(),N),m)}function K(b,l,h){const m=+$(b,h?.in),[N,f]=[+$(l.start,h?.in),+$(l.end,h?.in)].sort((E,i)=>E-i);return m>=N&&m<=f}function O(b,l,h){return Ne(b,-l,h)}const De=()=>{const{isDemo:b,transactions:l,maxTransactions:h,loading:m}=ce(),{expenseCategories:N,incomeCategories:f}=ge(),E=D.useMemo(()=>{const t=localStorage.getItem("analytics-period");if(t)try{return JSON.parse(t)}catch{return{period:"month"}}return{period:"month"}},[]),[i,Q]=D.useState(E.period||"month"),[x,B]=D.useState(E.customRange||{from:"",to:""}),[r,X]=D.useState({}),{t:a,i18n:Z}=de(),L=D.useMemo(()=>{if(!l.length)return{};const t=new Date;let n,c;switch(i){case"thisMonth":case"month":n=k(t),c=I(t);break;case"lastMonth":{const s=O(t,1);n=k(s),c=I(s);break}case"thisYear":case"year":n=je(t),c=ye(t);break;case"last3Months":n=k(O(t,2)),c=I(t);break;case"custom":x?.from&&x?.to?(n=new Date(x.from),c=new Date(x.to)):(n=k(t),c=I(t));break;default:n=k(t),c=I(t)}const g=l.filter(s=>{const o=s.date.toDate?s.date.toDate():new Date(s.date);return K(o,{start:n,end:c})}),j=g.filter(s=>s.type==="income").reduce((s,o)=>s+o.amount,0),d=g.filter(s=>s.type==="expense").reduce((s,o)=>s+o.amount,0),p=j-d,R={},A={};g.forEach(s=>{s.type==="expense"?R[s.category]=(R[s.category]||0)+s.amount:A[s.category]=(A[s.category]||0)+s.amount});const se=s=>a(`categories.${s}`,{defaultValue:s}),U=(s,o)=>se(o).replace(/^[^\p{L}\p{N}]+/u,"").trim(),ae=Object.entries(R).sort(([,s],[,o])=>o-s).slice(0,5).map(([s,o])=>{const y=N.find(S=>S.value===s);return{category:s,amount:o,percentage:d>0?o/d*100:0,label:U(y?.label||s,s),emoji:y?y.label.split(" ")[0]:"ðŸ’¸"}}),ne=Object.entries(A).sort(([,s],[,o])=>o-s).slice(0,5).map(([s,o])=>{const y=f.find(S=>S.value===s);return{category:s,amount:o,percentage:j>0?o/j*100:0,label:U(y?.label||s,s),emoji:y?y.label.split(" ")[0]:"ðŸ’°"}}),Y=[];for(let s=5;s>=0;s--){const o=k(O(t,s)),y=I(O(t,s)),S=l.filter(u=>{const F=u.date.toDate?u.date.toDate():new Date(u.date);return K(F,{start:o,end:y})}),_=S.filter(u=>u.type==="income").reduce((u,F)=>u+F.amount,0),H=S.filter(u=>u.type==="expense").reduce((u,F)=>u+F.amount,0);Y.push({month:q(o,"MMM yyyy"),income:_,expense:H,balance:_-H})}const re=j>0?(j-d)/j*100:0,oe=d/Math.max(1,(c-n)/(1e3*60*60*24)),le=g.length>0?g.reduce((s,o)=>s+o.amount,0)/g.length:0;return{totalIncome:j,totalExpense:d,balance:p,savingsRate:re,avgDailyExpense:oe,avgTransactionAmount:le,topExpenseCategories:ae,topIncomeCategories:ne,monthlyTrend:Y,transactionCount:g.length,periodLabel:i,startDate:n,endDate:c,filteredTransactions:g}},[l,i,x,N,f,a]);D.useEffect(()=>{X(L)},[L]),D.useEffect(()=>{localStorage.setItem("analytics-period",JSON.stringify({period:i,customRange:x}))},[i,x]);const ee=()=>{if(!r?.filteredTransactions?.length)return;const t=["Data","Tipo","Descrizione","Categoria","Importo"],n=r.filteredTransactions.map(p=>{const R=p.date.toDate?p.date.toDate():new Date(p.date);return[q(R,"yyyy-MM-dd"),p.type,`"${(p.description||"").replace(/"/g,'""')}"`,p.category||"",p.amount]}),c=[t.join(","),...n.map(p=>p.join(","))].join(`
`),g=new Blob([c],{type:"text/csv;charset=utf-8;"}),j=URL.createObjectURL(g),d=document.createElement("a");d.href=j,d.setAttribute("download",`analytics-${i}.csv`),document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(j)},te=async()=>{!r?.filteredTransactions?.length||!r.startDate||!r.endDate||await ve(r.filteredTransactions,r.startDate,r.endDate,i==="custom"?`${a("analytics.custom")} (${x.from} - ${x.to})`:i,Z.language)};return m?e.jsxs("div",{className:"space-y-4",children:[e.jsx(P,{height:48}),e.jsx("div",{className:"grid gap-3 md:grid-cols-2 lg:grid-cols-4",children:[...Array(4)].map((t,n)=>e.jsx(P,{height:120,borderRadius:18},n))}),e.jsx(P,{height:220,borderRadius:18})]}):e.jsxs("div",{className:"page-shell",children:[e.jsxs(J.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(z,{className:"text-primary"})," ",a("analytics.title")]}),e.jsx("p",{className:"text-muted-foreground",children:a("analytics.subtitle")})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:gap-4 md:flex-wrap",children:[e.jsxs(be,{value:i,onChange:t=>Q(t.target.value),className:"md:w-48 h-11 self-center",children:[e.jsx("option",{value:"month",children:a("analytics.thisMonth")}),e.jsx("option",{value:"lastMonth",children:a("analytics.lastMonth")}),e.jsx("option",{value:"last3Months",children:a("analytics.last3Months")}),e.jsx("option",{value:"year",children:a("analytics.thisYear")}),e.jsx("option",{value:"custom",children:a("analytics.custom")})]}),i==="custom"&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 md:gap-3 text-sm md:items-center md:pl-1",children:[e.jsx("label",{className:"text-muted-foreground text-xs md:text-sm leading-none",children:a("analytics.from")}),e.jsx("input",{type:"date",value:x.from,onChange:t=>B(n=>({...n,from:t.target.value})),className:"h-11 rounded-lg border border-border bg-background px-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background md:min-w-[170px]"}),e.jsx("label",{className:"text-muted-foreground text-xs md:text-sm leading-none",children:a("analytics.to")}),e.jsx("input",{type:"date",value:x.to,onChange:t=>B(n=>({...n,to:t.target.value})),className:"h-11 rounded-lg border border-border bg-background px-3 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background md:min-w-[170px]"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(G,{variant:"outline",onClick:ee,disabled:!r?.filteredTransactions?.length,children:a("analytics.exportCsv")}),e.jsx(G,{variant:"outline",onClick:te,disabled:!r?.filteredTransactions?.length,children:a("analytics.exportPdf")})]})]})]}),b&&e.jsxs("div",{className:"rounded-xl border border-primary/20 bg-primary/5 px-3 py-2 text-sm text-primary flex items-center gap-2",children:[e.jsxs(me,{variant:"secondary",children:[l.length,"/",h]}),e.jsx("span",{children:a("analytics.demoDescription",{current:l.length,max:h})})]})]}),e.jsx(J.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},children:e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[{title:a("analytics.totalIncome"),value:r.totalIncome,icon:e.jsx(xe,{}),color:"text-emerald-600"},{title:a("analytics.totalExpense"),value:r.totalExpense,icon:e.jsx(pe,{}),color:"text-rose-600"},{title:a("analytics.balance"),value:r.balance,icon:e.jsx(z,{}),color:"text-primary"},{title:a("analytics.totalTransactions"),value:r.transactionCount,icon:e.jsx(ue,{}),color:"text-muted-foreground"}].map((t,n)=>e.jsxs(C,{children:[e.jsx(T,{children:e.jsxs(w,{className:"flex items-center gap-2 text-base",children:[e.jsx("span",{className:`text-lg ${t.color}`,children:t.icon}),t.title]})}),e.jsx(M,{children:e.jsx("p",{className:"text-2xl font-semibold",children:typeof t.value=="number"&&n!==3?v(t.value):t.value})})]},n))})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(C,{children:[e.jsxs(T,{children:[e.jsx(w,{children:a("analytics.topExpenseCategories")}),e.jsx(W,{children:a("analytics.ofTotal")})]}),e.jsx(M,{className:"space-y-3",children:r.topExpenseCategories?.length?r.topExpenseCategories.map((t,n)=>e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.emoji}),e.jsx("span",{className:"font-semibold",children:t.label})]}),e.jsx("span",{className:"text-rose-600 font-semibold",children:v(t.amount)})]}),e.jsx("div",{className:"h-2 w-full rounded-full bg-muted",children:e.jsx("div",{className:"h-2 rounded-full bg-rose-500",style:{width:`${t.percentage.toFixed(1)}%`}})})]},n)):e.jsx("p",{className:"text-sm text-muted-foreground",children:a("analytics.noExpenseData")})})]}),e.jsxs(C,{children:[e.jsxs(T,{children:[e.jsx(w,{children:a("analytics.topIncomeCategories")}),e.jsx(W,{children:a("analytics.ofTotal")})]}),e.jsx(M,{className:"space-y-3",children:r.topIncomeCategories?.length?r.topIncomeCategories.map((t,n)=>e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.emoji}),e.jsx("span",{className:"font-semibold",children:t.label})]}),e.jsx("span",{className:"text-emerald-600 font-semibold",children:v(t.amount)})]}),e.jsx("div",{className:"h-2 w-full rounded-full bg-muted",children:e.jsx("div",{className:"h-2 rounded-full bg-emerald-500",style:{width:`${t.percentage.toFixed(1)}%`}})})]},n)):e.jsx("p",{className:"text-sm text-muted-foreground",children:a("analytics.noIncomeData")})})]})]}),e.jsxs(C,{children:[e.jsx(T,{children:e.jsx(w,{children:a("analytics.monthlyTrend")})}),e.jsx(M,{className:"grid gap-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6",children:r.monthlyTrend?.length?r.monthlyTrend.map((t,n)=>e.jsxs("div",{className:`rounded-xl border border-border p-3 ${t.balance>=0?"bg-emerald-500/5":"bg-rose-500/5"}`,children:[e.jsx("p",{className:"text-sm font-semibold",children:t.month}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-emerald-600",children:[e.jsx(he,{})," ",v(t.income)]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-rose-600",children:[e.jsx(fe,{})," ",v(t.expense)]}),e.jsx("p",{className:`text-sm font-semibold ${t.balance>=0?"text-emerald-600":"text-rose-600"}`,children:v(t.balance)})]},n)):e.jsx("p",{className:"text-sm text-muted-foreground",children:a("analytics.insufficientData")})})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(C,{children:[e.jsx(T,{children:e.jsx(w,{children:a("analytics.avgDailyExpense")})}),e.jsxs(M,{children:[e.jsx("p",{className:"text-2xl font-semibold text-primary",children:v(r.avgDailyExpense||0)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("analytics.inSelectedPeriod")})]})]}),e.jsxs(C,{children:[e.jsx(T,{children:e.jsx(w,{children:a("analytics.avgTransaction")})}),e.jsxs(M,{children:[e.jsx("p",{className:"text-2xl font-semibold text-primary",children:v(r.avgTransactionAmount||0)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("analytics.avgTransactionDescription")})]})]}),e.jsxs(C,{children:[e.jsx(T,{children:e.jsx(w,{children:a("analytics.totalTransactions")})}),e.jsxs(M,{children:[e.jsx("p",{className:"text-2xl font-semibold text-primary",children:r.transactionCount||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("analytics.inSelectedPeriod")})]})]})]})]})},Re=ie.memo(De);export{Re as default};
