import{R as _,s as J,t as K,a2 as V,Q as Y,h as Z,i as ee,r as l,k as ae,j as e,x as re,o as T,a3 as se,n as x,a4 as ie,_ as te,a5 as le,l as f,a6 as U,a7 as ne,a8 as oe,a9 as ce,aa as de,y as S,z as d,A as m,ab as F,ac as me,ad as ue}from"./index-BBbaY5_X.js";import{f as pe}from"./formatCurrency-DQxE0pTn.js";import{C as v}from"./Card-BFkG-Ruz.js";import{R as xe}from"./Row-K7qL0jRb.js";import{C as fe}from"./Col-BZr0GMUm.js";import{F as o}from"./Form-BzVAdWKs.js";import{M as h}from"./Modal-Ddr6LxAg.js";const he=()=>{const{currentUser:s,logout:D}=J(),{transactions:j,getStats:N}=K(),{theme:w,toggleTheme:E}=V(),u=Y(),z=Z(),R=ee({maxWidth:768}),[g,M]=l.useState({}),[A,p]=l.useState(!1),[t,k]=l.useState(""),[b,L]=l.useState(!1),[n,y]=l.useState(""),{t:a,i18n:C}=ae();l.useEffect(()=>{N&&M(N())},[j,N]),l.useEffect(()=>{(async()=>{if(s?.uid)try{const i=await S(d(m,"users",s.uid));i.exists()?y(i.data().username||s.displayName||s.email?.split("@")[0]||""):y(s.displayName||s.email?.split("@")[0]||"")}catch(i){console.error("Errore nel caricamento username:",i)}})()},[s]);const B=async()=>{await D(),z("/")},W=r=>{const i=r.target.value;E(i)},I=async r=>{try{return!(await S(d(m,"usernames",r.toLowerCase()))).exists()}catch(i){return console.error("Errore nel controllo username:",i),!1}},P=async()=>{if(!t.trim()||t.length<3){u.error(a("profile.usernameMinLength"));return}if(t.toLowerCase()===n.toLowerCase()){u.info(a("profile.usernameSame")),p(!1);return}if(window.confirm(a("profile.usernameConfirm",{currentUsername:n,newUsername:t}))){L(!0);try{if(!await I(t)){u.error(a("profile.usernameUnavailable"));return}if(await F(d(m,"usernames",t.toLowerCase()),{uid:s.uid,createdAt:new Date}),await F(d(m,"users",s.uid),{username:t.toLowerCase(),displayName:t,updatedAt:new Date},{merge:!0}),await me(s,{displayName:t}),n&&n.toLowerCase()!==t.toLowerCase())try{await ue(d(m,"usernames",n.toLowerCase()))}catch(X){console.warn("Errore nella rimozione del vecchio username (non critico):",X)}const c=await S(d(m,"users",s.uid));c.exists()?y(c.data().username):y(t),k(""),u.success(a("profile.usernameSuccess"))}catch(i){console.error("Errore nell'aggiornamento username:",i);let c=a("profile.usernameError");i.code==="permission-denied"?c=a("profile.usernamePermissionError"):i.code==="network-request-failed"&&(c=a("profile.usernameNetworkError")),u.error(c)}finally{L(!1),p(!1)}}},H=s?.metadata?.creationTime?new Date(s.metadata.creationTime).toLocaleDateString("it-IT"):a("profile.dateNotAvailable"),O=s?.email?s.email.charAt(0).toUpperCase():"?",Q=l.useMemo(()=>[{title:a("profile.totalTransactions"),value:j.length,icon:e.jsx(re,{size:20}),suffix:"",color:"var(--accent-info)",bgColor:"var(--pastel-sky)"},{title:a("profile.currentBalance"),value:g.balance||0,icon:e.jsx(T,{size:20}),formatter:r=>pe(r),color:g.balance>=0?"var(--accent-success)":"var(--accent-error)",bgColor:g.balance>=0?"var(--pastel-mint)":"var(--pastel-coral)"},{title:a("profile.daysActive"),value:s?.metadata?.creationTime?Math.floor((Date.now()-new Date(s.metadata.creationTime))/(1e3*60*60*24)):0,icon:e.jsx(se,{size:20}),suffix:` ${a("profile.days")}`,color:"var(--accent-warning)",bgColor:"var(--pastel-cream)"}],[j.length,g.balance,s?.metadata?.creationTime,a]),$=l.useMemo(()=>[{value:"light",label:a("profile.themeLight")},{value:"dark",label:a("profile.themeDark")},{value:"system",label:a("profile.themeSystem")}],[a]),q=[{value:"it",label:"Italiano"},{value:"en",label:"English"}],G=r=>{C.changeLanguage(r.target.value),localStorage.setItem("appLanguage",r.target.value)};return e.jsxs("div",{style:{padding:R?"1rem 0":"2rem 0",maxWidth:"1000px",margin:"0 auto",minHeight:"100vh",backgroundColor:"var(--background-primary)",color:"var(--text-primary)"},children:[e.jsx(x.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-4",children:e.jsx(v,{className:"border-0 shadow-sm text-center glass-card",style:{borderRadius:"2rem",background:"rgba(255,255,255,0.04)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.08)"},children:e.jsxs(v.Body,{className:"p-5",children:[e.jsx("div",{className:"rounded-circle mx-auto d-flex align-items-center justify-content-center mb-4",style:{width:"100px",height:"100px",background:"var(--gradient-soft-blue)",color:"var(--primary-600)",fontSize:"2.5rem",fontWeight:"bold",border:"3px solid rgba(59, 130, 246, 0.2)"},children:O}),e.jsx("h3",{className:"text-dark fw-bold mb-3",children:n||a("profile.user")}),e.jsxs("div",{className:"d-flex align-items-center justify-content-center gap-2 mb-2",children:[e.jsx(ie,{className:"text-muted",size:16}),e.jsx("span",{className:"text-muted",children:s?.email})]}),e.jsxs("div",{className:"d-flex align-items-center justify-content-center gap-2",children:[e.jsx(te,{className:"text-muted",size:16}),e.jsxs("span",{className:"text-muted",children:[a("profile.registeredOn")," ",H]})]})]})})}),e.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},className:"mb-4",children:[e.jsxs("h4",{className:"text-dark fw-semibold mb-4 d-flex align-items-center gap-2",children:[e.jsx(T,{size:20}),a("profile.statsTitle")]}),e.jsx(xe,{className:"g-3",children:Q.map((r,i)=>e.jsx(fe,{xs:12,sm:4,children:e.jsx(v,{className:"border-0 shadow-sm text-center h-100 glass-card",style:{borderRadius:"1.5rem",background:"rgba(255,255,255,0.04)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.08)"},children:e.jsxs(v.Body,{className:"p-4",children:[e.jsx("div",{className:"mb-3 rounded-circle mx-auto d-flex align-items-center justify-content-center",style:{width:"48px",height:"48px",backgroundColor:r.color+"20",color:r.color},children:r.icon}),e.jsx("div",{className:"mb-2",children:e.jsxs("div",{className:"fw-bold text-dark",style:{fontSize:"1.5rem"},children:[r.formatter?r.formatter(r.value):r.value,r.suffix&&e.jsx("span",{className:"text-muted fs-6",children:r.suffix})]})}),e.jsx("div",{className:"text-muted fw-medium small",children:r.title})]})})},i))})]}),e.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.6},className:"mb-4",children:[e.jsxs("h4",{className:"text-dark fw-semibold mb-3 d-flex align-items-center gap-2",children:[e.jsx(le,{size:20}),a("profile.settingsTitle")]}),e.jsxs("div",{className:"d-flex flex-column gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsx("div",{className:"fw-medium text-dark",children:a("profile.theme")}),e.jsx(o.Select,{value:w,onChange:W,style:{width:"140px",borderRadius:"8px",fontSize:"14px",background:"transparent",border:"1px solid var(--border-primary)",color:"var(--text-primary)"},children:$.map(r=>e.jsxs("option",{value:r.value,children:[r.icon," ",r.label]},r.value))})]}),e.jsxs("div",{className:"text-muted small mb-2",children:[a("profile.currentTheme"),": ",a(w==="dark"?"profile.themeDark":w==="light"?"profile.themeLight":"profile.themeSystem")]}),e.jsx("hr",{className:"my-2",style:{opacity:.12}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsx("div",{className:"fw-medium text-dark",children:a("profile.language")}),e.jsx(o.Select,{value:C.language,onChange:G,style:{width:"140px",borderRadius:"8px",fontSize:"14px",background:"transparent",border:"1px solid var(--border-primary)",color:"var(--text-primary)"},children:q.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsxs("div",{className:"text-muted small mb-2",children:[a("profile.currentLanguage"),": ",C.language==="it"?"Italiano":"English"]}),e.jsx("hr",{className:"my-2",style:{opacity:.12}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsx("div",{className:"fw-medium text-dark",children:a("profile.username")}),e.jsxs(f,{variant:"outline-primary",size:"sm",onClick:()=>{k(n),p(!0)},className:"d-flex align-items-center gap-2",style:{borderRadius:"8px",fontSize:"14px",background:"transparent",border:"1px solid var(--primary-300)",color:"var(--primary-600)"},children:[e.jsx(U,{size:12}),a("profile.edit")]})]}),e.jsxs("div",{className:"text-muted small mb-2",children:[a("profile.currentUsername"),": ",n]}),e.jsx("hr",{className:"my-2",style:{opacity:.12}})]})]})]}),e.jsx(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.8},className:"mb-4",children:e.jsxs("div",{style:{borderRadius:0,background:"none",border:"none",padding:0,margin:0},children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-1",style:{fontWeight:500,color:"var(--primary-600)"},children:[e.jsx(ne,{size:16}),a("profile.account"),": ",s?.email]}),e.jsx("div",{className:"text-muted small",children:a("profile.accountInfo")})]})}),e.jsxs(x.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:1},className:"d-flex justify-content-center gap-3 flex-wrap",children:[e.jsx(f,{variant:"primary",onClick:()=>z("/dashboard"),style:{borderRadius:"20px",minWidth:"160px",padding:"12px 24px",background:"linear-gradient(135deg, var(--primary-500), var(--primary-600))",border:"none"},children:a("profile.backToDashboard")}),e.jsxs(f,{variant:"outline-danger",onClick:B,className:"d-flex align-items-center gap-2",style:{borderRadius:"20px",minWidth:"160px",padding:"12px 24px",backgroundColor:"var(--pastel-coral)",borderColor:"var(--accent-error)",color:"var(--accent-error)"},children:[e.jsx(oe,{size:16}),a("logout")]})]}),e.jsxs(h,{show:A,onHide:()=>p(!1),centered:!0,backdrop:"static",children:[e.jsx(h.Header,{closeButton:!0,style:{backgroundColor:"var(--surface-primary)",borderBottom:"1px solid var(--border-primary)"},children:e.jsxs(h.Title,{className:"d-flex align-items-center gap-2",children:[e.jsx(U,{size:20}),a("profile.editUsername")]})}),e.jsx(h.Body,{style:{backgroundColor:"var(--surface-primary)"},children:e.jsx(o,{children:e.jsxs(o.Group,{className:"mb-3",children:[e.jsx(o.Label,{className:"fw-semibold text-dark",children:a("profile.newUsername")}),e.jsx(o.Control,{type:"text",value:t,onChange:r=>k(r.target.value),placeholder:a("profile.usernamePlaceholder"),disabled:b,style:{borderRadius:"8px",backgroundColor:"var(--surface-secondary)",border:"1px solid var(--border-primary)"}}),e.jsx(o.Text,{className:"text-muted",children:a("profile.usernameHelp")})]})})}),e.jsxs(h.Footer,{style:{backgroundColor:"var(--surface-primary)",borderTop:"1px solid var(--border-primary)"},children:[e.jsxs(f,{variant:"outline-secondary",onClick:()=>p(!1),disabled:b,children:[e.jsx(ce,{size:16,className:"me-1"}),a("cancel")]}),e.jsx(f,{variant:"primary",onClick:P,disabled:b||!t.trim()||t.length<3,children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"spinner-border spinner-border-sm me-2",role:"status",children:e.jsx("span",{className:"visually-hidden",children:a("loading")})}),a("profile.updating")]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{size:16,className:"me-1"}),a("confirm")]})})]})]})]})},ke=_.memo(he);export{ke as default};
