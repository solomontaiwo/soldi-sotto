import{R as _,i as J,k as ee,M as ae,z as re,b as se,d as ie,r as l,e as te,j as e,o as le,g as z,O as ne,m as p,Q as oe,K as ce,S as de,f as h,T as F,U as me,V as ue,W as xe,X as pe,p as L,q as d,s as m,Y as D,Z as he,$ as fe}from"./index-DhPDyLgL.js";import{f as ge,S as f}from"./formatCurrency-9CSuPI7Y.js";import{C as j}from"./Card-CRPIQ7jH.js";import{R as be}from"./Row-B3jRwWjC.js";import{C as ye}from"./Col-BtPTxbzW.js";import{F as o}from"./Form-DqIPrd7s.js";import{M as g}from"./Modal-CtcGh7Z4.js";import"./useEventCallback-BQY3u4oO.js";const ve=()=>{const{currentUser:s,loading:R,logout:E}=J(),{transactions:N,getStats:w,loading:M}=ee(),A=R||M,{theme:k,toggleTheme:B}=ae(),u=re(),T=se(),W=ie({maxWidth:768}),[b,I]=l.useState({}),[P,x]=l.useState(!1),[t,C]=l.useState(""),[y,U]=l.useState(!1),[n,v]=l.useState(""),{t:a,i18n:S}=te();l.useEffect(()=>{w&&I(w())},[N,w]),l.useEffect(()=>{(async()=>{if(s?.uid)try{const i=await L(d(m,"users",s.uid));i.exists()?v(i.data().username||s.displayName||s.email?.split("@")[0]||""):v(s.displayName||s.email?.split("@")[0]||"")}catch(i){console.error("Errore nel caricamento username:",i)}})()},[s]);const O=async()=>{await E(),T("/")},H=r=>{const i=r.target.value;B(i)},$=async r=>{try{return!(await L(d(m,"usernames",r.toLowerCase()))).exists()}catch(i){return console.error("Errore nel controllo username:",i),!1}},q=async()=>{if(!t.trim()||t.length<3){u.error(a("profile.usernameMinLength"));return}if(t.toLowerCase()===n.toLowerCase()){u.info(a("profile.usernameSame")),x(!1);return}if(window.confirm(a("profile.usernameConfirm",{currentUsername:n,newUsername:t}))){U(!0);try{if(!await $(t)){u.error(a("profile.usernameUnavailable"));return}if(await D(d(m,"usernames",t.toLowerCase()),{uid:s.uid,createdAt:new Date}),await D(d(m,"users",s.uid),{username:t.toLowerCase(),displayName:t,updatedAt:new Date},{merge:!0}),await he(s,{displayName:t}),n&&n.toLowerCase()!==t.toLowerCase())try{await fe(d(m,"usernames",n.toLowerCase()))}catch(Z){console.warn("Errore nella rimozione del vecchio username (non critico):",Z)}const c=await L(d(m,"users",s.uid));c.exists()?v(c.data().username):v(t),C(""),u.success(a("profile.usernameSuccess"))}catch(i){console.error("Errore nell'aggiornamento username:",i);let c=a("profile.usernameError");i.code==="permission-denied"?c=a("profile.usernamePermissionError"):i.code==="network-request-failed"&&(c=a("profile.usernameNetworkError")),u.error(c)}finally{U(!1),x(!1)}}},Q=s?.metadata?.creationTime?new Date(s.metadata.creationTime).toLocaleDateString("it-IT"):a("profile.dateNotAvailable"),X=s?.email?s.email.charAt(0).toUpperCase():"?",G=l.useMemo(()=>[{title:a("profile.totalTransactions"),value:N.length,icon:e.jsx(le,{size:20}),suffix:"",color:"var(--accent-info)",bgColor:"var(--pastel-sky)"},{title:a("profile.currentBalance"),value:b.balance||0,icon:e.jsx(z,{size:20}),formatter:r=>ge(r),color:b.balance>=0?"var(--accent-success)":"var(--accent-error)",bgColor:b.balance>=0?"var(--pastel-mint)":"var(--pastel-coral)"},{title:a("profile.daysActive"),value:s?.metadata?.creationTime?Math.floor((Date.now()-new Date(s.metadata.creationTime))/(1e3*60*60*24)):0,icon:e.jsx(ne,{size:20}),suffix:` ${a("profile.days")}`,color:"var(--accent-warning)",bgColor:"var(--pastel-cream)"}],[N.length,b.balance,s?.metadata?.creationTime,a]),K=l.useMemo(()=>[{value:"light",label:a("profile.themeLight")},{value:"dark",label:a("profile.themeDark")},{value:"system",label:a("profile.themeSystem")}],[a]),V=[{value:"it",label:"Italiano"},{value:"en",label:"English"}],Y=r=>{S.changeLanguage(r.target.value),localStorage.setItem("appLanguage",r.target.value)};return A?e.jsxs("div",{className:"container py-4",children:[e.jsxs("div",{className:"d-flex align-items-center gap-3 mb-4",children:[e.jsx(f,{circle:!0,width:64,height:64}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx(f,{height:22,width:180,style:{marginBottom:8}}),e.jsx(f,{height:16,width:120})]})]}),e.jsx("div",{className:"row g-4 mb-4",children:[...Array(3)].map((r,i)=>e.jsx("div",{className:"col-12 col-md-4",children:e.jsx(f,{height:90,borderRadius:18})},i))}),e.jsx("div",{className:"mb-4",children:e.jsx(f,{height:180,borderRadius:24})})]}):e.jsxs("div",{style:{padding:W?"1rem 0":"2rem 0",maxWidth:"1000px",margin:"0 auto",minHeight:"100vh",backgroundColor:"var(--background-primary)",color:"var(--text-primary)"},children:[e.jsx(p.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},className:"mb-4",children:e.jsx(j,{className:"border-0 shadow-sm text-center glass-card",style:{borderRadius:"2rem",background:"rgba(255,255,255,0.04)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.08)"},children:e.jsxs(j.Body,{className:"p-5",children:[e.jsx("div",{className:"rounded-circle mx-auto d-flex align-items-center justify-content-center mb-4",style:{width:"100px",height:"100px",background:"var(--gradient-soft-blue)",color:"var(--primary-600)",fontSize:"2.5rem",fontWeight:"bold",border:"3px solid rgba(59, 130, 246, 0.2)"},children:X}),e.jsx("h3",{className:"text-dark fw-bold mb-3",children:n||a("profile.user")}),e.jsxs("div",{className:"d-flex align-items-center justify-content-center gap-2 mb-2",children:[e.jsx(oe,{className:"text-muted",size:16}),e.jsx("span",{className:"text-muted",children:s?.email})]}),e.jsxs("div",{className:"d-flex align-items-center justify-content-center gap-2",children:[e.jsx(ce,{className:"text-muted",size:16}),e.jsxs("span",{className:"text-muted",children:[a("profile.registeredOn")," ",Q]})]})]})})}),e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.2},className:"mb-4",children:[e.jsxs("h4",{className:"text-dark fw-semibold mb-4 d-flex align-items-center gap-2",children:[e.jsx(z,{size:20}),a("profile.statsTitle")]}),e.jsx(be,{className:"g-3",children:G.map((r,i)=>e.jsx(ye,{xs:12,sm:4,children:e.jsx(j,{className:"border-0 shadow-sm text-center h-100 glass-card",style:{borderRadius:"1.5rem",background:"rgba(255,255,255,0.04)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.08)"},children:e.jsxs(j.Body,{className:"p-4",children:[e.jsx("div",{className:"mb-3 rounded-circle mx-auto d-flex align-items-center justify-content-center",style:{width:"48px",height:"48px",backgroundColor:r.color+"20",color:r.color},children:r.icon}),e.jsx("div",{className:"mb-2",children:e.jsxs("div",{className:"fw-bold text-dark",style:{fontSize:"1.5rem"},children:[r.formatter?r.formatter(r.value):r.value,r.suffix&&e.jsx("span",{className:"text-muted fs-6",children:r.suffix})]})}),e.jsx("div",{className:"text-muted fw-medium small",children:r.title})]})})},i))})]}),e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.6},className:"mb-4",children:[e.jsxs("h4",{className:"text-dark fw-semibold mb-3 d-flex align-items-center gap-2",children:[e.jsx(de,{size:20}),a("profile.settingsTitle")]}),e.jsxs("div",{className:"d-flex flex-column gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsx("div",{className:"fw-medium text-dark",children:a("profile.theme")}),e.jsx(o.Select,{value:k,onChange:H,style:{width:"140px",borderRadius:"8px",fontSize:"14px",background:"transparent",border:"1px solid var(--border-primary)",color:"var(--text-primary)"},children:K.map(r=>e.jsxs("option",{value:r.value,children:[r.icon," ",r.label]},r.value))})]}),e.jsxs("div",{className:"text-muted small mb-2",children:[a("profile.currentTheme"),": ",a(k==="dark"?"profile.themeDark":k==="light"?"profile.themeLight":"profile.themeSystem")]}),e.jsx("hr",{className:"my-2",style:{opacity:.12}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsx("div",{className:"fw-medium text-dark",children:a("profile.language")}),e.jsx(o.Select,{value:S.language.split("-")[0],onChange:Y,style:{width:"140px",borderRadius:"8px",fontSize:"14px",background:"transparent",border:"1px solid var(--border-primary)",color:"var(--text-primary)"},children:V.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsxs("div",{className:"text-muted small mb-2",children:[a("profile.currentLanguage"),": ",S.language==="it"?"Italiano":"English"]}),e.jsx("hr",{className:"my-2",style:{opacity:.12}})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex align-items-center justify-content-between mb-2",children:[e.jsx("div",{className:"fw-medium text-dark",children:a("profile.username")}),e.jsxs(h,{variant:"outline-primary",size:"sm",onClick:()=>{C(n),x(!0)},className:"d-flex align-items-center gap-2",style:{borderRadius:"8px",fontSize:"14px",background:"transparent",border:"1px solid var(--primary-300)",color:"var(--primary-600)"},children:[e.jsx(F,{size:12}),a("profile.edit")]})]}),e.jsxs("div",{className:"text-muted small mb-2",children:[a("profile.currentUsername"),": ",n]}),e.jsx("hr",{className:"my-2",style:{opacity:.12}})]})]})]}),e.jsx(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.8},className:"mb-4",children:e.jsxs("div",{style:{borderRadius:0,background:"none",border:"none",padding:0,margin:0},children:[e.jsxs("div",{className:"d-flex align-items-center gap-2 mb-1",style:{fontWeight:500,color:"var(--primary-600)"},children:[e.jsx(me,{size:16}),a("profile.account"),": ",s?.email]}),e.jsx("div",{className:"text-muted small",children:a("profile.accountInfo")})]})}),e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:1},className:"d-flex justify-content-center gap-3 flex-wrap",children:[e.jsx(h,{variant:"primary",onClick:()=>T("/dashboard"),style:{borderRadius:"20px",minWidth:"160px",padding:"12px 24px",background:"linear-gradient(135deg, var(--primary-500), var(--primary-600))",border:"none"},children:a("profile.backToDashboard")}),e.jsxs(h,{variant:"outline-danger",onClick:O,className:"d-flex align-items-center gap-2",style:{borderRadius:"20px",minWidth:"160px",padding:"12px 24px",backgroundColor:"var(--pastel-coral)",borderColor:"var(--accent-error)",color:"var(--accent-error)"},children:[e.jsx(ue,{size:16}),a("logout")]})]}),e.jsxs(g,{show:P,onHide:()=>x(!1),centered:!0,backdrop:"static",children:[e.jsx(g.Header,{closeButton:!0,style:{backgroundColor:"var(--surface-primary)",borderBottom:"1px solid var(--border-primary)"},children:e.jsxs(g.Title,{className:"d-flex align-items-center gap-2",children:[e.jsx(F,{size:20}),a("profile.editUsername")]})}),e.jsx(g.Body,{style:{backgroundColor:"var(--surface-primary)"},children:e.jsx(o,{children:e.jsxs(o.Group,{className:"mb-3",children:[e.jsx(o.Label,{className:"fw-semibold text-dark",children:a("profile.newUsername")}),e.jsx(o.Control,{type:"text",value:t,onChange:r=>C(r.target.value),placeholder:a("profile.usernamePlaceholder"),disabled:y,style:{borderRadius:"8px",backgroundColor:"var(--surface-secondary)",border:"1px solid var(--border-primary)"}}),e.jsx(o.Text,{className:"text-muted",children:a("profile.usernameHelp")})]})})}),e.jsxs(g.Footer,{style:{backgroundColor:"var(--surface-primary)",borderTop:"1px solid var(--border-primary)"},children:[e.jsxs(h,{variant:"outline-secondary",onClick:()=>x(!1),disabled:y,children:[e.jsx(xe,{size:16,className:"me-1"}),a("cancel")]}),e.jsx(h,{variant:"primary",onClick:q,disabled:y||!t.trim()||t.length<3,children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"spinner-border spinner-border-sm me-2",role:"status",children:e.jsx("span",{className:"visually-hidden",children:a("loading")})}),a("profile.updating")]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{size:16,className:"me-1"}),a("confirm")]})})]})]})]})},Ue=_.memo(ve);export{Ue as default};
