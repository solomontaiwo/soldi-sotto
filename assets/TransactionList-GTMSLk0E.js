import{r as l,R as Me,c as Se,d as De,b as ke,a as Le,j as e,B as y,e as Z,i as Fe,k as Re,l as Ae,A as Ee,m as L,n as Ie,o as Oe}from"./index-CKPR3vxF.js";import{T as ze,D as Pe,a as _e,b as Be,c as Qe,d as Ue,e as qe}from"./TransactionModal-pqCmbY-t.js";import{t as He,a as R,n as $e,s as ee,i as Ve,S as F,b as Q,f as te}from"./statsUtils-D-Aizpya.js";import{u as We}from"./categories-CRFxhrzE.js";import{I as Ge}from"./label-BUzeNU8d.js";import{u as Ke}from"./useDateRange-BOKvRfzY.js";import{f as U,i as Ye,e as Je}from"./it-B5-30pgl.js";function Xe(r,c,i){const h=He(r,i?.in);return isNaN(c)?R(r,NaN):(h.setDate(h.getDate()+c),h)}function se(r){return R(r,Date.now())}function ae(r,c,i){const[h,x]=$e(i?.in,r,c);return+ee(h)==+ee(x)}function Ze(r,c){return ae(R(r,r),se(r))}function et(r,c,i){return Xe(r,-1,i)}function tt(r,c){return ae(R(r,r),et(se(r)))}const st=(r,c)=>{const[i,h]=l.useState(""),[x,C]=l.useState("all"),[p,d]=l.useState("all");return{filteredTransactions:l.useMemo(()=>{if(!r||r.length===0)return[];const{startDate:T,endDate:w}=c;return[...r].sort((m,j)=>j.date-m.date).filter(m=>{if(T&&w&&(!m.date||!Ve(m.date,{start:T,end:w})))return!1;if(i){const j=i.toLowerCase(),f=m.description.toLowerCase().includes(j),M=m.category.toLowerCase().includes(j);if(!f&&!M)return!1}return!(x!=="all"&&m.category!==x||p!=="all"&&m.type!==p)})},[r,c,i,x,p]),searchTerm:i,setSearchTerm:h,selectedCategory:x,setSelectedCategory:C,selectedType:p,setSelectedType:d}},at=()=>{const{currentUser:r,loading:c}=Se(),{transactions:i,loading:h,deleteTransaction:x,addTransaction:C,updateTransaction:p,isDemo:d,canAddMoreTransactions:A,maxTransactions:T,fetchAllTransactions:w,getTotalTransactionCount:E}=De(),{expenseCategories:m,incomeCategories:j}=We(),[f,M]=l.useState(null),[g,S]=l.useState(null),[ne,I]=l.useState(!1),[D,re]=l.useState(!1),[u,b]=l.useState([]),[O,q]=l.useState(!1),[z,ie]=l.useState(!0),[P,k]=l.useState(0),{period:le,setPeriod:oe,startDate:ce,endDate:de}=Ke("monthly");l.useEffect(()=>{(async()=>{if(r&&!d){const n=await E({onRevalidated:k});k(n)}else d&&k(i.length)})()},[r,d,E,i]),l.useEffect(()=>{i.length>0&&b(t=>{const n=new Map(t.map(s=>[s.id,s]));return i.forEach(s=>{n.set(s.id,s)}),t.length===0||t.length<=i.length?[...i].sort((s,o)=>o.date-s.date):Array.from(n.values()).sort((s,o)=>o.date-s.date)})},[i]);const H=async()=>{q(!0);const t=await w({onRevalidated:b});b(t),k(t.length),ie(!1),q(!1)},$=l.useRef(null);l.useEffect(()=>{const t=new IntersectionObserver(s=>{s[0].isIntersecting&&z&&!O&&!d&&u.length>0&&P>u.length&&H()},{threshold:.1,rootMargin:"100px"}),n=$.current;return n&&t.observe(n),()=>{n&&t.unobserve(n)}},[z,O,d,u.length,P,H]);const{filteredTransactions:ue,searchTerm:V,setSearchTerm:me,selectedCategory:W,setSelectedCategory:he,selectedType:G,setSelectedType:xe}=st(u.length>0?u:i,{startDate:ce,endDate:de}),{t:a,i18n:_}=ke(),fe=Le({maxWidth:768}),pe=c||h&&u.length===0,N=l.useMemo(()=>a("dashboard.motivationalQuotes",{returnObjects:!0}),[a]),[ge,ye]=l.useState("");l.useEffect(()=>{N&&N.length>0&&ye(N[Math.floor(Math.random()*N.length)])},[N]);const K=t=>t==="it"?Ye:Je,Y=t=>{const n=_.language||"it";if(Ze(t))return a("transactions.today");if(tt(t))return a("transactions.yesterday");const s=K(n);return U(t,n==="it"?"d MMMM yyyy":"MMMM d, yyyy",{locale:s})},je=t=>{const n={};return t.forEach(s=>{const o=s.date,v=U(o,"yyyy-MM-dd");n[v]||(n[v]={date:o,displayDate:Y(o),transactions:[]}),n[v].transactions.push(s)}),Object.values(n).sort((s,o)=>o.date-s.date)},J=t=>{const s=[...m,...j].find(o=>o.value===t);return s?s.label:a(`categories.${t}`,{defaultValue:t})},ve=l.useCallback(async t=>{S(t)},[]),be=l.useCallback(async()=>{g&&(await x(g)&&S(null),b(n=>n.filter(s=>s.id!==g)))},[g,x]),Ne=[...new Set(u.length>0?u.map(t=>t.category):i.map(t=>t.category))],Ce=[{value:"daily",label:a("transactions.filters.today")},{value:"weekly",label:a("transactions.filters.week")},{value:"monthly",label:a("transactions.filters.month")},{value:"annually",label:a("transactions.filters.year")},{value:"all",label:a("transactions.filters.all")}],Te=l.useCallback(async t=>{const n=t.amount?.toString().replace(",",".")||"",s=parseFloat(n);if(Number.isNaN(s)||s<=0)return!1;const o={type:t.type,amount:s,description:t.description,date:new Date(t.date),category:t.category};if(f){const v=await p(f.id,o);return v&&b(we=>we.map(B=>B.id===f.id?{...B,...o}:B)),v}return C(o)},[C,p,f]);if(pe)return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsx(F,{height:120,borderRadius:16}),e.jsx(F,{height:120,borderRadius:16})]}),[...Array(4)].map((t,n)=>e.jsxs("div",{className:"space-y-3",children:[e.jsx(F,{width:140,height:20}),e.jsx(F,{height:72,borderRadius:18})]},n))]});if(!r&&!d)return e.jsx("div",{className:"min-h-[60vh] flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("h2",{className:"text-2xl font-semibold",children:a("transactions.accessRequired")}),e.jsx("p",{className:"text-muted-foreground",children:a("transactions.loginRequired")})]})});const X=je(ue);return e.jsxs("div",{className:"page-shell -mt-6 pt-0",children:[e.jsxs("div",{className:"sticky top-0 z-20 rounded-2xl border border-border bg-card/90 backdrop-blur-md p-3 md:p-4 shadow-md",children:[e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-xl md:text-2xl font-bold flex items-center gap-2",children:["ðŸ’³ ",a("transactions.title")]}),e.jsx("div",{className:"text-primary text-sm italic",children:ge})]}),e.jsxs(y,{onClick:()=>I(!0),disabled:d&&!A,className:"gap-2",children:[e.jsx(Z,{}),!fe&&a("addTransaction")]})]}),e.jsxs("div",{className:"mt-3 flex flex-col gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Fe,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground"}),e.jsx(Ge,{className:"pl-10",placeholder:a("searchTransactions"),value:V,onChange:t=>me(t.target.value)})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row",children:[e.jsx(Q,{value:le,onChange:t=>oe(t.target.value),className:"md:flex-1",children:Ce.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsxs(y,{variant:D?"default":"outline",size:"sm",onClick:()=>re(!D),className:"w-full md:w-auto gap-2",children:[e.jsx(Re,{}),a(D?"transactions.filters.hide":"transactions.filters.show")]})]}),d&&e.jsxs("div",{className:"rounded-xl border border-primary/20 bg-primary/5 px-3 py-2 text-sm text-primary flex items-center gap-2",children:[e.jsxs(Ae,{variant:"secondary",children:[i.filter(t=>!t.isSample).length,"/",T]}),e.jsx("span",{children:a("transactions.demoMode")})]}),e.jsx(Ee,{children:D&&e.jsxs(L.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"grid gap-3 md:grid-cols-2",children:[e.jsxs(Q,{value:G,onChange:t=>xe(t.target.value),children:[e.jsx("option",{value:"all",children:a("transactions.filters.allTypes")}),e.jsx("option",{value:"income",children:a("income")}),e.jsx("option",{value:"expense",children:a("expense")})]}),e.jsxs(Q,{value:W,onChange:t=>he(t.target.value),children:[e.jsx("option",{value:"all",children:"Categorie"}),Ne.map(t=>e.jsx("option",{value:t,children:t.charAt(0).toUpperCase()+t.slice(1)},t))]})]})})]})]}),e.jsxs("div",{className:"space-y-4 pb-6 pt-3",children:[X.length>0?X.map((t,n)=>e.jsxs(L.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:n*.05},className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-px flex-1 bg-border"}),e.jsx("span",{className:"rounded-full bg-muted px-3 py-1 text-xs font-semibold text-muted-foreground",children:t.displayDate}),e.jsx("div",{className:"h-px flex-1 bg-border"})]}),e.jsx("div",{className:"space-y-2",children:t.transactions.map(s=>e.jsxs(L.div,{initial:{opacity:0,x:-12},animate:{opacity:1,x:0},className:"flex items-center justify-between rounded-2xl border border-border bg-card/80 p-4 shadow-sm",children:[e.jsx("div",{className:"flex items-start gap-3",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-base font-semibold leading-tight",children:s.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:U(s.date,_.language==="it"?"dd MMM yyyy":"MMM dd, yyyy",{locale:K(_.language)})}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:J(s.category)})]})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:`text-base font-bold ${s.type==="income"?"text-emerald-600":"text-rose-600"}`,children:[s.type==="income"?"+":"-",te(s.amount)]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(y,{size:"sm",variant:"ghost",className:"h-9 w-9 p-0",onClick:o=>{o.stopPropagation(),M(s)},children:e.jsx(Ie,{className:"h-4 w-4"})}),e.jsx(y,{size:"sm",variant:"ghost",className:"h-9 w-9 p-0 text-destructive hover:text-destructive",onClick:o=>{o.stopPropagation(),ve(s.id)},children:e.jsx(Oe,{className:"h-4 w-4"})})]})]})]},s.id))})]},t.date.toISOString())):e.jsxs(L.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"text-center py-10",children:[e.jsx("h3",{className:"text-xl font-semibold text-foreground",children:a("transactions.empty.title")}),e.jsx("p",{className:"text-muted-foreground",children:a(V||W!=="all"||G!=="all"?"transactions.empty.tryFilters":"transactions.empty.addFirst")}),e.jsxs(y,{className:"mt-4 gap-2",onClick:()=>I(!0),disabled:d&&!A,children:[e.jsx(Z,{}),a("addTransaction")]})]}),z&&!d&&u.length>0&&P>u.length&&e.jsx("div",{ref:$,className:"flex justify-center py-6",children:O&&e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground text-sm",children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent"}),a("loading")]})})]}),e.jsx(ze,{show:ne||!!f,onClose:()=>{I(!1),M(null)},onSubmit:Te,transaction:f}),e.jsx(Pe,{open:!!g,onOpenChange:t=>!t&&S(null),children:e.jsxs(_e,{children:[e.jsxs(Be,{children:[e.jsx(Qe,{children:a("confirmDelete")}),e.jsx(Ue,{children:a("transactions.deleteConfirm")})]}),(()=>{const t=u.find(n=>n.id===g)||i.find(n=>n.id===g);return t?e.jsxs("div",{className:"py-4 space-y-1",children:[e.jsx("div",{className:"font-bold text-foreground",children:t.description}),e.jsxs("div",{className:"text-muted-foreground text-sm",children:[Y(t.date)," â€¢"," ",J(t.category)]}),e.jsxs("div",{className:`font-semibold ${t.type==="income"?"text-emerald-600":"text-rose-600"}`,children:[t.type==="income"?"+":"-",te(t.amount)]})]}):null})(),e.jsxs(qe,{className:"gap-2",children:[e.jsx(y,{variant:"outline",onClick:()=>S(null),children:a("cancel")}),e.jsx(y,{variant:"destructive",onClick:be,children:a("transactions.deleteConfirm")})]})]})})]})},ut=Me.memo(at);export{ut as default};
